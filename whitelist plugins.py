#!#/usr/bin/env python3
# Whitelists plugins by adding their checksum to the database file
#
# Author: Optic_Fusion1
# Date: 5/29/2021

import os
import sqlite3
import hashlib
import sys
import re
import zipfile
import yaml

conn = sqlite3.connect("database.db")
cursor = conn.cursor()

# Could probably do this better, it works however so fuck it
for file in os.listdir("whitelisted plugins"):
    file_path = os.path.join('whitelisted plugins', os.fsdecode(file))
    if file_path == "whitelisted plugins\desktop.ini":
        continue
    with open(file_path, 'rb') as f:
        # Creates the file checksum
        checksum = hashlib.sha1()
        while chunk := f.read(8102):
            checksum.update(chunk)
        checksum = checksum.hexdigest().upper()
        authorName = "NotFound"
        pluginName = "NotFound"
        # Gets plugin.yml plugin name
        with zipfile.ZipFile(file_path) as z:
            for fileName in z.namelist():
                if fileName == "plugin.yml": # 
                    with z.open(fileName) as f:
                        try:
                            yml = yaml.safe_load(f)
                            try:
                                if "authors" in yml.keys():
                                    authorName = yml["authors"][0]
                                if "author" in yml.keys():
                                    authorName = yml["author"]
                            except:
                                print("Couldn't load authors from plugin.yml file in " + file_path)
                            pluginName = yml["name"]
                            # Gets plugin id from file name, -1 if not found
                            m = re.search("(id\(\d+\))", file_path)
                            pluginId = -1;
                            if m:
                                pluginId = re.sub('\D', '', m.groups()[0])
                            # Adds plugin to database
                            try:
                                cursor.execute("INSERT INTO WhitelistedChecksums ('Checksum','WhitelistedPlugin') VALUES (?, ?)", (checksum, pluginId))
                                cursor.execute("INSERT INTO WhitelistedPlugins ('Name', 'Author', 'ResourceID') VALUES (?, ?, ?)", (pluginName, authorName, pluginId))
                                conn.commit()
                                print("Whitelisted " + file + " (Name: " + pluginName + " Id: " + pluginId + " Author: " + authorName + ")")
                            except:
                                print(file + " is already whitelisted")
                                continue
                        except:
                            print("Couldn't load plugin.yml in file " + file_path)
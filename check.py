# Checks malware checksums against the DB to find any that aren't in the database
#
# Author: Optic_Fusion1
# Date: 5/14/2021

import os
import sqlite3
import hashlib
import sys

conn = sqlite3.connect("database.db")
cursor = conn.cursor()
output = open('output.txt', 'a')

# Could probably do this better, it works however so fuck it
for file in os.listdir("malware"):
    file_path = os.path.join('malware', os.fsdecode(file))
    #output.write("Checking to see if " + file_path + " is in the database\n")
    with open(file_path, 'rb') as f:
        checksum = hashlib.sha1()
        while chunk := f.read(8102):
            checksum.update(chunk)
        checksum = checksum.hexdigest().upper()
        cursor.execute('SELECT * FROM BlacklistedChecksums WHERE Checksum=?', (checksum,))
        row = cursor.fetchone()
        # Improve logging, should log to console as well
        if row is None:
            output.write(checksum + " is not in the database Path: " + file_path + "\n")
        #else:
        #    output.write("Found!\n")